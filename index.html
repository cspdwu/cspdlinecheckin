<script>
    const LIFF_ID = '2008925313-hrsUUpmB';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVDz_HHLYEt5GulNKkmkKuD-f5q-piht1cQzzXHzRYg29YdJWXuOWeJm3Bzuxngl3KKQ/exec';
    let userId = '';
    let userData = null; // เพิ่มตัวแปรสำหรับเก็บข้อมูลนักศึกษาที่โหลดมาได้

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            userId = profile.userId;
            checkUserStatus();
        } catch (err) {
            console.error(err);
            alert('LIFF Initialization failed');
        }
    }

    async function checkUserStatus() {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'checkStatus', userId: userId })
        });
        const result = await response.json();
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');

        if (result.registered) {
            userData = result.userData; // เก็บข้อมูลไว้ใช้ตอนเช็คอิน
            document.getElementById('checkinArea').classList.remove('hidden');
            document.getElementById('dispName').innerText = userData.fullName;
            document.getElementById('dispId').innerText = userData.studentId;
        } else {
            document.getElementById('regForm').classList.remove('hidden');
        }
    }

    async function register() {
        const studentId = document.getElementById('studentId').value;
        const fullName = document.getElementById('fullName').value;
        const school = document.getElementById('school').value;

        if (studentId.length !== 8 || !fullName || !school) {
            alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (รหัสต้องมี 8 หลัก)');
            return;
        }

        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loading').innerText = 'กำลังบันทึกการลงทะเบียน...';
        document.getElementById('loading').classList.remove('hidden');

        // ส่งข้อมูลลงทะเบียนไปที่ GAS เพื่อบันทึกลง Firebase
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'register', userId, studentId, fullName, school })
        });

        alert('ลงทะเบียนสำเร็จ!');
        location.reload();
    }

    function handleCheckIn() {
        const btn = document.getElementById('btnCheckin');
        btn.disabled = true;
        btn.innerText = 'กำลังตรวจสอบตำแหน่ง...';

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'checkin',
                    userId: userId,
                    studentId: userData.studentId, // ส่งข้อมูลที่เก็บไว้ไปด้วย
                    fullName: userData.fullName,     // ส่งข้อมูลที่เก็บไว้ไปด้วย
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                })
            });
            const result = await response.json();
            alert(result.message);
            if (result.status === 'success') {
                liff.closeWindow();
            } else {
                btn.disabled = false;
                btn.innerText = 'กดเพื่อเช็คอิน';
            }
        }, (err) => {
            alert('กรุณาเปิด GPS และอนุญาตให้เข้าถึงตำแหน่ง');
            btn.disabled = false;
            btn.innerText = 'กดเพื่อเช็คอิน';
        }, { enableHighAccuracy: true });
    }

    main();
</script>
